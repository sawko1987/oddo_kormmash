# Рефакторинг модуля парсинга

## Цель

Разбить большие файлы на модули размером не более 3500 токенов каждый для оптимизации расходов на использование AI.

## Структура до рефакторинга

```
models/
└── mrp_bom_import.py (872 строки, ~3500+ токенов)
```

## Структура после рефакторинга

```
models/
├── mrp_bom_import_parser.py      # Парсинг XLS файлов (~200 строк)
├── mrp_bom_import_helpers.py    # Вспомогательные методы (~250 строк)
├── mrp_bom_import_processor.py  # Обработка данных (~400 строк)
└── mrp_bom_import.py             # Основной класс (~25 строк, использует миксины)
```

## Описание модулей

### 1. `mrp_bom_import_parser.py`

**Класс:** `XlsParserMixin` (AbstractModel)

**Функциональность:**
- Парсинг XLS файлов
- Декодирование base64
- Чтение данных из Excel с помощью xlrd
- Преобразование строк в словари
- Обработка ошибок парсинга

**Методы:**
- `parse_xls_file(file_data)` - основной метод парсинга
- `_parse_row(sheet, row_idx)` - парсинг одной строки

### 2. `mrp_bom_import_helpers.py`

**Класс:** `ImportHelpersMixin` (AbstractModel)

**Функциональность:**
- Создание/получение продуктов
- Создание/получение единиц измерения
- Создание/получение валют
- Создание/получение рабочих центров
- Парсинг количеств и номеров строк
- Валидация связей владельцев

**Методы:**
- `get_or_create_product()`
- `get_or_create_uom()`
- `get_or_create_currency()`
- `get_or_create_workcenter()`
- `get_manufacture_route()`
- `_parse_quantity()`
- `_parse_owner_row()`
- `_validate_owner_relationship()`

### 3. `mrp_bom_import_processor.py`

**Класс:** `ImportProcessorMixin` (AbstractModel)

**Функциональность:**
- Обработка импортированных данных
- Двухпроходная обработка (определение продуктов, затем обработка всех объектов)
- Управление памятью и производительностью
- Создание BOM, строк BOM, операций

**Методы:**
- `process_import_data()` - основной метод обработки
- `_find_products()` - поиск продуктов уровня 1
- `_process_row()` - обработка одной строки
- `_process_nomenclature()` - обработка номенклатуры
- `_process_material()` - обработка материалов
- `_process_operation()` - обработка операций
- `_validate_and_create_bom_line()` - валидация и создание строки BOM
- `_clear_caches_if_needed()` - очистка кешей

### 4. `mrp_bom_import.py`

**Класс:** `MrpBomImport` (Model)

**Функциональность:**
- Основной класс для импорта BOM
- Наследуется от всех миксинов через `_inherit`
- Объединяет всю функциональность в одном классе

## Преимущества рефакторинга

1. ✅ **Снижение расходов на AI** - каждый файл теперь меньше 3500 токенов
2. ✅ **Улучшенная читаемость** - код разделен по функциональности
3. ✅ **Легче поддерживать** - изменения в одном модуле не затрагивают другие
4. ✅ **Переиспользование** - миксины можно использовать в других модулях
5. ✅ **Тестирование** - каждый модуль можно тестировать отдельно

## Совместимость

✅ Полная обратная совместимость - все методы доступны через основной класс `mrp.bom.import`

✅ API не изменился - все вызовы работают как раньше:
```python
import_helper = self.env['mrp.bom.import']
rows_data = import_helper.parse_xls_file(file_data)
stats = import_helper.process_import_data(rows_data)
```

## Правила для будущей разработки

См. файл `.cursorrules` в корне проекта для правил разбиения файлов.
